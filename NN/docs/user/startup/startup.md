# Установка и запуск

Навигация:

- [Установка зависимостей](#установка-зависимостей)
- [Обучение моделей](#обучение-моделей)
- [Добавление моделей в роутинг](#добавление-моделей-в-роутинг)
- [Настройка работы](#настройка-работы)
- [Запуск](#запуск)
- [Остановка работы](#остановка-работы)

> **Note**
>
> Возможно некоторые команды будет необходимо выполнять от имени суперпользователя.

---

## Установка зависимостей

Для работы Cortex необходимо установить [Docker](https://www.docker.com) и [Docker Compose](https://docs.docker.com/compose)

Установка Python-библиотек для [отладочных утилит](../../../utilities):

```shell
pip install -r requirements_test.txt 
```

---

## Обучение моделей

> **Note**
>
> Перед началом обучения необходимо установить зависимости из [`requirements.txt`](../../../requirements.txt)

Для запуска обучения нужно настроить его скрипт. Этот скрипт находится в директории [`train`](../../../train) и имеет имя вида `<имя_сегмента>_train.sh`.

После настройки можно запускать обучение:

```shell
./<имя_сегмента>_train.sh
```

> **Note**
>
> Сегменты Cortex имеют разные форматы датасетов. Подробнее см. в информации о нужном вам сегменте.

После окончания обучения в указанной в скрипте директории должна появится модель.

---

## Добавление моделей в роутинг

Добавлять модель в роутинг сервера нужно в файле [`routers.yml`](../../../routers.yml). Для этого необходимо найти пункт с нужным вам сегментом и добавить в подпункт `routers` следущее:

```yaml
# Путь к директории модели.
- model: "models/dialogue_replying/CDR-T"
  # Путь на сервере, на котором будет запущен роутер.
  # Полный путь будет иметь вид "<имя_сегмента>/<указанный_путь>", в данном случае это будет "/dialogue_replying/test".
  path: "test" 
  # Описание модели.
  description: "Тестовая диалоговая модель."
```

*После добавления роутеров необходимо включить роутинг сегмента в подпункте `enable`.*

---

## Настройка работы

Настройки работы комплекса находятся в файле [`configs/production.sh`](../../../configs/production.sh).

Важные переменные, которые необходимо настроить:

- `CORTEX_API_ENABLE_SWAGGER`

*Информация о каждой переменной указана в скрипте.*

Помимо этого, при необходимости можно также настроить порты:

- Внутренние *(только внутри контейнеров)*
  - [`configs/production.sh`](../../../configs/production.sh) - `export CORTEX_API_PORT=<порт>`
  - [`Dockerfile`](../../../Dockerfile) - `EXPOSE <порт>`
  - [`docker-compose.yml`](../../../docker-compose.yml) - `services.server.expose`
  - [`nginx.conf`](../../../nginx.conf) - `http` -> `server` -> `location` -> `proxy_pass`
- Внешние
  - [`docker-compose.yml`](../../../docker-compose.yml) - `services.balancer.ports`
  - [`nginx.conf`](../../../nginx.conf) - `http` -> `server` -> `listen`

---

## Запуск

Cortex запускается в Docker контейнерах, для возможности работы в нескольких процессах с балансировкой нагрузки.

> **Note**
>
> Перед работой с Docker [запустите его демон](https://docs.docker.com/config/daemon/start).

Сборка:

```shell
docker compose build
```

Запуск:

```shell
docker compose up
```

Для запуска без интерактивного режима укажите аргумент `-d`.

Чтобы запустить несколько контейнеров одновременно укажите нужное число в [`docker-compose.yml`](../../../docker-compose.yml) -> `services.server.deploy.replicas`.

> **Note**
>
> У каждого экземпляра Cortex будут собственный кэш.

---

## Остановка работы

Если комплекс был запущен в текущем окне терминала *(контейнер в интерактивном режиме)*, то остановить его работу в большинстве случаев можно нажатием сочетания клавиш `Ctrl+C`.

Для остановки контейнера работающего в фоне нужно выполнить следующую команду:

```shell
docker compose down
```
